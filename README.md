###### Copyright (C) 2021-2022, Xilinx, Inc.  All rights reserved.
###### Copyright (C) 2022-2025, Advanced Micro Devices, Inc.  All rights reserved.

###### SPDX-License-Identifier: MIT

# gen-machine-conf

This repo provides support to generate machine conf and plnxtool.conf 
files for the given HW file.

gen-machine-conf is a tool for creating [Yocto project](https://www.yoctoproject.org/) [machine configurations](https://docs.yoctoproject.org/ref-manual/variables.html#term-MACHINE) for [AMD FPGAs](https://www.amd.com/en/products/adaptive-socs-and-fpgas/fpga.html) from [Vivado](https://www.xilinx.com/products/design-tools/vivado.html) binary output, from [System Device Trees](https://www.devicetree.org/) generated by the [system device tree generator](https://github.com/Xilinx/system-device-tree-xlnx), or device trees created by hand from within a Yocto Project environment.

## Maintainers, Patches/Submissions, Community

gen-machine-conf maintainers occasionally review the github pull requests
associated with the project. There is no mailing list for submission of
patches, but for format and style guidance please see the OE community patch
submission guidelines, as described in:

https://docs.yoctoproject.org/dev/contributor-guide/submit-changes.html

**Maintainers:**

	Mark Hatle <mark.hatle@amd.com>
	Sandeep Gundlupet Raju <sandeep.gundlupet-raju@amd.com>
	John Toomey <john.toomey@amd.com>
	Varalaxmi Bingi <varalaxmi.bingi@amd.com>
	Raju Kumar Pothuraju <rajukumar.pothuraju@amd.com>
	Swagath Gadde <swagath.gadde@amd.com>
	Ashwini Lomate <ashwini.lomate@amd.com>


## Dependencies

This repo depends on:

	URI: https://git.yoctoproject.org/poky
	layers: meta, meta-poky
	branch: langdale

	URI: https://git.openembedded.org/meta-openembedded
	layers: meta-oe, meta-perl, meta-python, meta-filesystems, meta-gnome,
            meta-multimedia, meta-networking, meta-webserver, meta-xfce,
            meta-initramfs.
	branch: langdale

	URI:
        https://git.yoctoproject.org/meta-xilinx (official version)
        https://github.com/Xilinx/meta-xilinx (development and amd xilinx release)
	layers: meta-xilinx-core, meta-xilinx-microblaze, meta-xilinx-bsp,
            meta-xilinx-standalone, meta-xilinx-vendor.
	branch: langdale or amd xilinx release version (e.g. rel-v2023.1)

	URI:
        https://git.yoctoproject.org/meta-xilinx-tools (official version)
        https://github.com/Xilinx/meta-xilinx-tools (development and amd xilinx release)
	branch: langdale or amd xilinx release version (e.g. rel-v2023.1)

	URI: https://github.com/Xilinx/meta-petalinux
	branch: langdale or amd xilinx release version (e.g. rel-v2023.1)

## PetaLinux/Yocto XSA to Machine conf file generation using `gen-machine-conf` tool

This repo supports PetaLinux/Yocto XSA to Machine conf file generation using
`gen-machine-conf` tool. Below is the gen-machine-conf tool usage and examples.

### gen-machine-conf usage:

`gen-machine-conf` has two sub commands `parse-xsa` and `parse-sdt` you must use one or the other. Most options work for either sub command but some are only available/required in one sub command or the other.

`gen-machine-conf` is capible of auto-detecting the subcommand based on the file/URI specified with `--hw-description`.
If an `.xsa` file is specified, it uses the subcommand `parse-xsa`,Â and if system-top.dts is specified, it uses the subcommand `parse-sdt`.

If a directory is specified and it contains both a `.xsa` file and `system-top.dts`, the tool will use `system-top.dts`, (therefore assuming `parse-sdt`).

```bash
$ gen-machine-conf --help
NOTE: Starting bitbake server...
usage: gen-machine-conf [--hw-description [<PATH_TO_XSA>/<xsa_name>.xsa] or <PATH_TO_SDTDIR>] [--soc-family {microblaze,zynq,zynqmp,versal,versal-2ve-2vm}]
                        [--soc-variant SOC_VARIANT] [--machine-name MACHINE] [-c <config_dir>] [-r REQUIRE_MACHINE] [-O MACHINE_OVERRIDES]
                        [--output OUTPUT] [--native-sysroot NATIVE_SYSROOT] [--menuconfig [{project,rootfs}]] [--petalinux]
                        [--add-config [CONFIG_<macro>=y]] [--add-rootfsconfig ADD_ROOTFSCONFIG] [-D] [-h]
                        <subcommand> ...

PetaLinux/Yocto Machine Configuration File generation tool

required arguments:
  --hw-description [<PATH_TO_XSA>/<xsa_name>.xsa] or <PATH_TO_SDTDIR>
                        Specify Hardware(xsa) file or System Device-tree Directory

options:
  --soc-family {microblaze,zynq,zynqmp,versal,versal-2ve-2vm}
                        SOC family type from choice list (usually auto detected).
  --soc-variant SOC_VARIANT
                        SOC Variant: Ex: cg, dr, eg, ev, ai-prime, premium (usually auto detected).
  --machine-name MACHINE
                        Provide a name to generate machine configuration
  -c <config_dir>, --config-dir <config_dir>
                        Location of the build conf directory
  -r REQUIRE_MACHINE, --require-machine REQUIRE_MACHINE
                        This machine will be required, instead of the generic machine if defined
  -O MACHINE_OVERRIDES, --machine-overrides MACHINE_OVERRIDES
                        Provide additional overrides to the generated machine
  --output OUTPUT       Output directory name
  --native-sysroot NATIVE_SYSROOT
                        Native sysroot path to use the mconf/conf or lopper commands.
  --menuconfig [{project,rootfs}]
                        UI menuconfig option to update configuration(default is project).
                        project - To update System Level configurations
                        rootfs  - To update Rootfs configurations
  --petalinux           Generate Rootfs and PetaLinux Tool conf files and update the build/local.conf file with generated .conf files.
  --add-config [CONFIG_<macro>=y]
                        Specify config macro or file containing config macros to be added on top of default configs
  --add-rootfsconfig ADD_ROOTFSCONFIG
                        Specify a file with list of package names to add into rootfs menu entry
  -D, --debug           Enable debug output
  -h, --help            show this help message and exit

subcommands:
  <subcommand>
    parse-sdt           Parse System devicet-tree file and generate Yocto/PetaLinux configurations.
    parse-xsa           Parse xsa file and generate Yocto/PetaLinux configurations.

Use gen-machine-conf <subcommand> --help to get help on a specific command
$
```

#### gen-machine-conf `parse-xsa` usage:
The `parse-xsa` is the "older" way of getting hardware configuration information into Yocto. It uses the output of AMD Vivado&trade; Design Suite directly.

```bash
$ gen-machine-conf parse-xsa --help
NOTE: Starting bitbake server...
usage: gen-machine-conf parse-xsa [--hw-description <PATH_TO_XSA>/<xsa_name>.xsa] [other options]

options:
  -h, --help            show this help message and exit
  --xsct-tool [XSCT_TOOL_PATH]
                        Vivado or Vitis XSCT path to use xsct commands (Optional if you are already have AMD tools in your path)
  -l <config_file>, --localconf <config_file>
                        Write local.conf changes to this file
  --multiconfigfull     Generate/Enable Full set of multiconfig .conf and .dts files. Default is minimal
  --multiconfigenable   Enable multiconfig support. default is disabled.
$

```

#### gen-machine-conf `parse-sdt` usage:
The `parse-sdt` is the "newer" way of getting hardware configuration information into Yocto. It uses the output of AMD Vivado&trade; Design Suite after it has been processed by System Device Tree Generator.

```bash
$ gen-machine-conf parse-sdt --help
NOTE: Starting bitbake server...
usage: gen-machine-conf parse-sdt [--hw-description <PATH_TO_SDTDIR>] [other options]

options:
  -h, --help            show this help message and exit
  -g {full,dfx}, --gen-pl-overlay {full,dfx}
                        Generate pl overlay for full, dfx configuration using xlnx_overlay_dt lopper script
  -d <domain_file>, --domain-file <domain_file>
                        Path to domain file (.yaml/.dts)
  -i <psu_init_path>, --psu-init-path <psu_init_path>
                        Path to psu_init or ps7_init files, defaults to system device tree output directory
  -p <pl_path>, --pl <pl_path>
                        Path to pdi or bitstream file
  -l <config_file>, --localconf <config_file>
                        Write local.conf changes to this file
  --multiconfigfull     Generate/Enable Full set of multiconfig .conf and .dts files. Default is minimal. Search for CONFIG_YOCTO_BBMC prefix in
                        --menuconfig to get the available multiconfig targets.
  --dts-path <dts_path>
                        Absolute path or subdirectory of conf/dts to place DTS files in (usually auto detected from DTS)
$
```

> **Note:**
> When using gen-machine-conf in Yocto the SDT builds `--soc-family` arguments is not mandatory as the needed information is provided by the system device tree.

### Examples

The below examples generally take one of five forms:

1. `parse-xsa` Custom .xsa; This is an example of using the `.xsa` file output by AMD Vivado&trade; Design Suite
2. `parse-xsa` .xsa from AMD; This is an example of using an AMD&trade; provided xsa from our JFrog Artifactory. `gen-machine-conf` is capable of ingesting these directly from the web at `https://petalinux.xilinx.com/sswreleases/rel-v<VERSION>/hdf-examples/<VERSION>`
3. `parse-sdt` Without pl overlay; This method is for when users want their programmable logic loaded at boot by the AMD&trade; bootloaders
4. `parse-sdt` With full bitstream pl overlay; This method is used when users want to delay loading of their programmable logic until the software (e.x. U-Boot, Linux) can perform the load.
5. `parse-sdt` With dfx static pl overlay; This method is used when users want some of their programmable logic loaded by the AMD&trade; bootloaders but still have some re-configurable regions in their PL.

#### .xsa file based (deprecated):


```bash
# Custom .xsa:
$ gen-machine-conf --soc-family <microblaze|zynq|zynqmp|versal> --hw-description <path_to_custom_xsa>/<project_name>.xsa --machine-name <your-custom-name>
```

```bash
# .xsa from AMD:
$ gen-machine-conf --soc-family <microblaze|zynq|zynqmp|versal> --hw-description <path_to_hdf_artifactory>/<board_and_project_name>/system.xsa --machine-name <name_based_on_project>
```

#### System device tree based:

> **Note:** MicroBlaze is not supported in system device tree generator at this time.

> **Note:** Zinq-7000 does not support DFX static pl overlay


```bash
# Without pl overlay
$ gen-machine-conf --hw-description /<path_to_sdtdir>/ -c conf -l conf/local.conf --machine-name <your-custom-name>
```

```bash
# With full bitstream pl overlay
$ gen-machine-conf --hw-description /<path_to_sdtdir>/ -c conf -l conf/local.conf --machine-name <your-custom-name> -g full
```

```bash
# With dfx static pl overlay
$ gen-machine-conf --hw-description /<PATH_TO_SDTDIR>/ -c conf -l conf/local.conf --machine-name zynqmp-zcu102-sdt -g dfx
```

#### Using a custom xsct install location

```bash
# BSP method:
$ gen-machine-conf parse-xsa --soc-family versal --hw-description /<path_to_hdf_artifactory>/vck190-versal/system.xsa --machine-name vck190-versal --xsct-tool /<Vitis_or_Petalinux_install_directory>/tools/xsct
```

#### Using gen-machine-conf with native sysroot:

`gen-machine-conf` needs the additional host tools like conf, mconf and lopper tools.
You can get these tools by downloading and installing pre-built buildtools installer from
https://petalinux.xilinx.com/sswreleases/<VERSION\>/sdkupdate/buildtools.

```bash
# Locate and download the pre-built buildtools
$ wget https://petalinux.xilinx.com/sswreleases/rel-v2024.2/sdkupdate/buildtools
$ chmod a+x ./buildtools

# Execute the installation script
$ ./buildtools -d /<installation_dir>/x86-sysroot -y

# Specify installed SDK to gen-machine-conf
$ source /<installation_dir>/x86-sysroot/environment-setup-x86_64-petalinux-linux
$ gen-machine-conf --hw-description /<path_to_sdtdir>/

(OR)
$ gen-machine-conf --hw-description /<path_to_sdtdir>/ --native-sysroot /<installation_dir>/x86-sysroot/sysroots/x86_64-petalinux-linux/

```
