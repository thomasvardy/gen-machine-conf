###### Copyright (C) 2021-2022, Xilinx, Inc.  All rights reserved.
###### Copyright (C) 2022-2025, Advanced Micro Devices, Inc.  All rights reserved.

###### SPDX-License-Identifier: MIT

# gen-machine-conf

This repo provides support to generate machine conf and plnxtool.conf 
files for the given HW file.

gen-machine-conf is a tool for creating [Yocto project](https://www.yoctoproject.org/) [machine configurations](https://docs.yoctoproject.org/ref-manual/variables.html#term-MACHINE) for [AMD FPGAs](https://www.amd.com/en/products/adaptive-socs-and-fpgas/fpga.html) from [Vivado](https://www.xilinx.com/products/design-tools/vivado.html) binary output, from [System Device Trees](https://www.devicetree.org/) generated by the [system device tree generator](https://github.com/Xilinx/system-device-tree-xlnx), or device trees created by hand from within a Yocto Project environment.

## Maintainers, Patches/Submissions, Community

gen-machine-conf maintainers occasionally review the github pull requests
associated with the project. There is no mailing list for submission of
patches, but for format and style guidance please see the OE community patch
submission guidelines, as described in:

https://docs.yoctoproject.org/dev/contributor-guide/submit-changes.html

**Maintainers:**

	Mark Hatle <mark.hatle@amd.com>
	Sandeep Gundlupet Raju <sandeep.gundlupet-raju@amd.com>
	John Toomey <john.toomey@amd.com>
	Varalaxmi Bingi <varalaxmi.bingi@amd.com>
	Raju Kumar Pothuraju <rajukumar.pothuraju@amd.com>
	Swagath Gadde <swagath.gadde@amd.com>
	Ashwini Lomate <ashwini.lomate@amd.com>


## Dependencies

This repo depends on:

	URI: https://git.yoctoproject.org/poky
	layers: meta, meta-poky
	branch: langdale

	URI: https://git.openembedded.org/meta-openembedded
	layers: meta-oe, meta-perl, meta-python, meta-filesystems, meta-gnome,
            meta-multimedia, meta-networking, meta-webserver, meta-xfce,
            meta-initramfs.
	branch: langdale

	URI:
        https://git.yoctoproject.org/meta-xilinx (official version)
        https://github.com/Xilinx/meta-xilinx (development and amd xilinx release)
	layers: meta-xilinx-core, meta-xilinx-microblaze, meta-xilinx-bsp,
            meta-xilinx-standalone, meta-xilinx-vendor.
	branch: langdale or amd xilinx release version (e.g. rel-v2023.1)

	URI:
        https://git.yoctoproject.org/meta-xilinx-tools (official version)
        https://github.com/Xilinx/meta-xilinx-tools (development and amd xilinx release)
	branch: langdale or amd xilinx release version (e.g. rel-v2023.1)

	URI: https://github.com/Xilinx/meta-petalinux
	branch: langdale or amd xilinx release version (e.g. rel-v2023.1)

## PetaLinux/Yocto XSA to Machine conf file generation using gen-machineconf tool

This repo supports PetaLinux/Yocto XSA to Machine conf file generation using
gen-machineconf tool. Below is the gen-machineconf tool usage and examples.

* gen-machineconf usage:

```bash
$ gen-machineconf --help
NOTE: Starting bitbake server...
usage: gen-machine-conf [--hw-description [<PATH_TO_XSA>/<xsa_name>.xsa] or <PATH_TO_SDTDIR>] [--soc-family {microblaze,zynq,zynqmp,versal,versal2}]
                        [--soc-variant SOC_VARIANT] [--machine-name MACHINE] [-c <config_dir>] [-r REQUIRE_MACHINE] [-O MACHINE_OVERRIDES]
                        [--output OUTPUT] [--native-sysroot NATIVE_SYSROOT] [--menuconfig [{project,rootfs}]] [--petalinux]
                        [--add-config [CONFIG_<macro>=y]] [--add-rootfsconfig ADD_ROOTFSCONFIG] [-D] [-h]
                        <subcommand> ...

PetaLinux/Yocto Machine Configuration File generation tool

required arguments:
  --hw-description [<PATH_TO_XSA>/<xsa_name>.xsa] or <PATH_TO_SDTDIR>
                        Specify Hardware(xsa) file or System Device-tree Directory

options:
  --soc-family {microblaze,zynq,zynqmp,versal,versal2}
                        SOC family type from choice list (usually auto detected).
  --soc-variant SOC_VARIANT
                        SOC Variant: Ex: cg, dr, eg, ev, ai-prime, premium (usually auto detected).
  --machine-name MACHINE
                        Provide a name to generate machine configuration
  -c <config_dir>, --config-dir <config_dir>
                        Location of the build conf directory
  -r REQUIRE_MACHINE, --require-machine REQUIRE_MACHINE
                        This machine will be required, instead of the generic machine if defined
  -O MACHINE_OVERRIDES, --machine-overrides MACHINE_OVERRIDES
                        Provide additional overrides to the generated machine
  --output OUTPUT       Output directory name
  --native-sysroot NATIVE_SYSROOT
                        Native sysroot path to use the mconf/conf or lopper commands.
  --menuconfig [{project,rootfs}]
                        UI menuconfig option to update configuration(default is project).
                        project - To update System Level configurations
                        rootfs  - To update Rootfs configurations
  --petalinux           Generate Rootfs and PetaLinux Tool conf files and update the build/local.conf file with generated .conf files.
  --add-config [CONFIG_<macro>=y]
                        Specify config macro or file containing config macros to be added on top of default configs
  --add-rootfsconfig ADD_ROOTFSCONFIG
                        Specify a file with list of package names to add into rootfs menu entry
  -D, --debug           Enable debug output
  -h, --help            show this help message and exit

subcommands:
  <subcommand>
    parse-sdt           Parse System devicet-tree file and generate Yocto/PetaLinux configurations.
    parse-xsa           Parse xsa file and generate Yocto/PetaLinux configurations.

Use gen-machine-conf <subcommand> --help to get help on a specific command
$
```

* gen-machineconf parse-xsa usage:

```bash
$ gen-machineconf parse-xsa --help
NOTE: Starting bitbake server...
usage: gen-machineconf parse-xsa [--hw-description <PATH_TO_XSA>/<xsa_name>.xsa] [other options]

options:
  -h, --help            show this help message and exit
  --xsct-tool [XSCT_TOOL_PATH]
                        Vivado or Vitis XSCT path to use xsct commands
  -l <config_file>, --localconf <config_file>
                        Write local.conf changes to this file
  --multiconfigfull     Generate/Enable Full set of multiconfig .conf and .dts files. Default is minimal
  --multiconfigenable   Enable multiconfig support. default is disabled.
$

```

* gen-machineconf parse-sdt usage:

```bash
$ gen-machineconf parse-sdt --help
NOTE: Starting bitbake server...
usage: gen-machineconf parse-sdt [--hw-description <PATH_TO_SDTDIR>] [other options]

options:
  -h, --help            show this help message and exit
  -g {full,dfx}, --gen-pl-overlay {full,dfx}
                        Generate pl overlay for full, dfx configuration using xlnx_overlay_dt lopper script
  -d <domain_file>, --domain-file <domain_file>
                        Path to domain file (.yaml/.dts)
  -i <psu_init_path>, --psu-init-path <psu_init_path>
                        Path to psu_init or ps7_init files, defaults to system device tree output directory
  -p <pl_path>, --pl <pl_path>
                        Path to pdi or bitstream file
  -l <config_file>, --localconf <config_file>
                        Write local.conf changes to this file
  --multiconfigfull     Generate/Enable Full set of multiconfig .conf and .dts files. Default is minimal. Search for CONFIG_YOCTO_BBMC prefix in
                        --menuconfig to get the available multiconfig targets.
  --dts-path <dts_path>
                        Absolute path or subdirectory of conf/dts to place DTS files in (usually auto detected from DTS)
$
```

> **Note:**
> Using gen-machineconf in Yocto
> 1. XSCT builds `--xsct-tool` arguments is not mandatory.
> 2. SDT builds `--soc-family` arguments is not mandatory.

* MicroBlaze XSCT Method:

```bash
# Custom xsa method
$ gen-machineconf parse-xsa --soc-family microblaze --hw-description /<PATH_TO_CUSTOM_XSA>/kc705-microblazeel/system.xsa --xsct-tool /<PETALINUX_INSTALLATION_DIR>/tools/xsct

# BSP method:
$ gen-machineconf parse-xsa --soc-family microblaze --hw-description /<PATH_TO_HDF_ARTIFACTORY>/kc705-microblazeel/system.xsa --machine-name kc705-microblazeel --xsct-tool /<PETALINUX_INSTALLATION_DIR>/tools/xsct

  HDF_ARTIFACTORY_PATH: https://petalinux.xilinx.com/sswreleases/rel-v<VERSION>/hdf-examples/<VERSION>
```

* Zynq-7000 XSCT Method:

```bash
# Custom xsa method
$ gen-machineconf parse-xsa --soc-family zynq --hw-description /<PATH_TO_CUSTOM_XSA>/zc702-zynq7/system.xsa --xsct-tool /<PETALINUX_INSTALLATION_DIR>/tools/xsct

# BSP method:
$ gen-machineconf  parse-xsa --soc-family zynq --hw-description /<PATH_TO_HDF_ARTIFACTORY>/zc702-zynq7/system.xsa --machine-name zc702-zynq7 --xsct-tool /<PETALINUX_INSTALLATION_DIR>/tools/xsct

  HDF_ARTIFACTORY_PATH: https://petalinux.xilinx.com/sswreleases/rel-v<VERSION>/hdf-examples/<VERSION>
```

* Zynq-7000 SDT Method:

```bash
# Without pl overlay
$ gen-machineconf parse-sdt --hw-description /<PATH_TO_SDTDIR>/ -c conf -l conf/local.conf --machine-name zynq7-zc702-sdt

# With full bitstream pl overlay
$ gen-machineconf parse-sdt --hw-description /<PATH_TO_SDTDIR>/ -c conf -l conf/local.conf --machine-name zynq7-zc702-sdt -g full

  SDT_ARTIFACTORY_PATH: https://petalinux.xilinx.com/sswreleases/rel-v<VERSION>/sdt/<VERSION>
```

* ZynqMP XSCT Method:

```bash
# Custom xsa method
$ gen-machineconf parse-xsa --soc-family zynqmp --hw-description /<PATH_TO_CUSTOM_XSA>/zcu106-zynqmp/system.xsa --xsct-tool /<PETALINUX_INSTALLATION_DIR>/tools/xsct

# BSP method:
$ gen-machineconf parse-xsa --soc-family zynqmp --hw-description /<PATH_TO_HDF_ARTIFACTORY>/zcu106-zynqmp/system.xsa --machine-name zcu106-zynqmp --xsct-tool /<PETALINUX_INSTALLATION_DIR>/tools/xsct

  HDF_ARTIFACTORY_PATH: https://petalinux.xilinx.com/sswreleases/rel-v<VERSION>/hdf-examples/<VERSION>
```

* ZynqMP SDT Method:

```bash
# Without pl overlay
$ gen-machineconf parse-sdt --hw-description /<PATH_TO_SDTDIR>/ -c conf -l conf/local.conf --machine-name zynqmp-zcu102-sdt

# With full bitstream pl overlay
$ gen-machineconf parse-sdt --hw-description /<PATH_TO_SDTDIR>/ -c conf -l conf/local.conf --machine-name zynqmp-zcu102-sdt -g full

# With dfx static pl overlay
$ gen-machineconf parse-sdt --hw-description /<PATH_TO_SDTDIR>/ -c conf -l conf/local.conf --machine-name zynqmp-zcu102-sdt -g dfx

  SDT_ARTIFACTORY_PATH: https://petalinux.xilinx.com/sswreleases/rel-v<VERSION>/sdt/<VERSION>
```

* Versal XSCT Method:

```bash
# Custom xsa method
$ gen-machineconf parse-xsa --soc-family versal --hw-description /<PATH_TO_CUSTOM_XSA>/vck190-versal/system.xsa --xsct-tool /<PETALINUX_INSTALLATION_DIR>/tools/xsct

# BSP method:
$ gen-machineconf parse-xsa --soc-family versal --hw-description /<PATH_TO_HDF_ARTIFACTORY>/vck190-versal/system.xsa --machine-name vck190-versal --xsct-tool /<PETALINUX_INSTALLATION_DIR>/tools/xsct

  HDF_ARTIFACTORY_PATH: https://petalinux.xilinx.com/sswreleases/rel-v<VERSION>/hdf-examples/<VERSION>
```

* Versal SDT Method:

```bash
# Without PL Overlay
$ gen-machineconf parse-sdt --hw-description /<PATH_TO_SDTDIR>/ -c conf -l conf/local.conf --machine-name zynqmp-zcu102-sdt

# With segmented configuration pl overlay
$ gen-machineconf parse-sdt --hw-description /<PATH_TO_SDTDIR>/ -c conf -l conf/local.conf --machine-name zynqmp-zcu102-sdt -g full

# With dfx static pl overlay
$ gen-machineconf parse-sdt --hw-description /<PATH_TO_SDTDIR>/ -c conf -l conf/local.conf --machine-name zynqmp-zcu102-sdt -g dfx

  SDT_ARTIFACTORY_PATH: https://petalinux.xilinx.com/sswreleases/rel-v<VERSION>/sdt/<VERSION>
```

* Using gen-machineconf without subcommand:

The Gen-machineconf utility can be able to auto-detect the subcommand based on the file/URI specified with --hw-description.
If xsa is specified, it uses the subcommand 'parse-xsa', and if system-top.dts is specified, it uses the subcommand 'parse-sdt'.
If directory is specified and it contains both xsa and system-top.dts, priority will be given to system-top.dts, and subcommand
will be 'parse-sdt'.

```bash
# xsa method
$ gen-machineconf --soc-family <soc_family> --hw-description <PATH_TO_CUSTOM_XSA> --xsct-tool /<PETALINUX_INSTALLATION_DIR>/tools/xsct

# SDT method
$ gen-machineconf --hw-description /<PATH_TO_SDTDIR>/ -c conf -l conf/local.conf --machine-name zynqmp-zcu102-sdt

  SDT_ARTIFACTORY_PATH: https://petalinux.xilinx.com/sswreleases/rel-v<VERSION>/sdt/<VERSION>
```

* Using gen-machineconf with native sysroot:

The Gen-machineconf utility needs the additional host tools like conf, mconf and lopper tools.
You can get these tools by downloading and installing pre-built buildtools installer from
https://petalinux.xilinx.com/sswreleases/<VERSION\>/sdkupdate/buildtools.

```bash
# Locate and download the pre-built buildtools
$ wget https://petalinux.xilinx.com/sswreleases/rel-v2024.2/sdkupdate/buildtools
$ chmod a+x ./buildtools

# Execute the installation script
$ ./buildtools -d /<INSTALLATION_DIR>/x86-sysroot -y

# Specify installed SDK to gen-machine-conf
$ source /<INSTALLATION_DIR>/x86-sysroot/environment-setup-x86_64-petalinux-linux
$ gen-machineconf --hw-description /<PATH_TO_SDTDIR>/

(OR)
$ gen-machineconf --hw-description /<PATH_TO_SDTDIR>/ --native-sysroot /<INSTALLATION_DIR>/x86-sysroot/sysroots/x86_64-petalinux-linux/

```
